<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Payment QR</title>
    <style>
        :root { --primary-black: #000301; --bg-color: #f5f7fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        .amt-label { font-size: 14px; color: #888; text-transform: uppercase; }
        .amt { font-size: 60px; color: var(--primary-green); font-weight: 800; margin: 10px 0; }
        #q img { width: 280px; height: 280px; border-radius: 18px; border: 1px solid #eee; }
        .name { font-size: 22px; font-weight: 600; color: #444; margin-top: 15px; }
        .idle-msg { height: 280px; display: flex; align-items: center; justify-content: center; color: #aaa; font-style: italic; border: 2px dashed #eee; border-radius: 18px; }
    </style>
</head>
<body>

    <div class="card">
        <div class="amt-label">Requested Amount</div>
        <div class="amt">â‚¹<span id="a">0</span></div>
        <div id="q"><div class="idle-msg">Connecting to server...</div></div>
        <div class="name" id="n">Initializing...</div>
    </div>

    <script>
        // PASTE YOUR GOOGLE SCRIPT URL HERE
        const API = "https://script.google.com/macros/s/AKfycbwWa0WNM5koQ2xt4tc5ABb9HTBJXxjQSIrZAp0Fa6UG0sxV8FW4Zo_X6fXRG8TVWde4/exec"; 
        
        let lastValue = "";
        let idleTimeout;

        function setIdle() {
            document.getElementById('n').innerText = "System Ready";
            document.getElementById('a').innerText = "0";
            document.getElementById('q').innerHTML = `<div class="idle-msg">Waiting for QR...</div>`;
            lastValue = "IDLE";
        }

        async function update() {
            try {
                // We add a timestamp to the URL to prevent browser caching
                const response = await fetch(`${API}?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                
                // If amount is 0, empty, or null -> Go Idle
                if (!data.live.upiid || !data.live.amount || data.live.amount == 0) {
                    if (lastValue !== "IDLE") setIdle();
                    return;
                }

                const currentValue = data.live.amount + data.live.upiid;
                
                if (currentValue !== lastValue) {
                    clearTimeout(idleTimeout);
                    
                    document.getElementById('n').innerText = data.live.name;
                    document.getElementById('a').innerText = data.live.amount;
                    
                    const upi = `upi://pay?pa=${data.live.upiid}&pn=${encodeURIComponent(data.live.name)}&am=${data.live.amount}&cu=INR`;
                    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=${encodeURIComponent(upi)}`;
                    
                    document.getElementById('q').innerHTML = `<img src="${qrUrl}" alt="QR Code">`;
                    lastValue = currentValue;

                    // Start 2-minute timer
                    idleTimeout = setTimeout(setIdle, 120000);
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById('n').innerText = "Offline - Retrying...";
            }
        }

        // Run immediately, then every 3 seconds
        update(); 
        setInterval(update, 3000);
    </script>
</body>
</html>